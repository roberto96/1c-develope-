&НаКлиенте
Процедура Отправить(Команда)
	//Проверка заполнености поля период если не заполнено - ошибкка
	Если не ЗначениеЗаполнено(Объект.Дата.ДатаНачала) и не ЗначениеЗаполнено(Объект.Дата.ДатаОкончания) тогда 
		сбп=Новый СообщениеПользователю;
		сбп.Текст = "Не полностью указан период!";
		сбп.Поле="Дата";
		сбп.ПутьКДанным = "Объект.Дата";
		сбп.Сообщить();
		Возврат;
	конецесли;	
	ТабДок = Новый ТабличныйДокумент;
	ОчиститьСообщения();
	Если ЗначениеЗаполнено(Объект.Дата.ДатаОкончания) и ЗначениеЗаполнено(Объект.Дата.ДатаНачала) тогда 
		ЗапускОтчета(ТабДок);
		Возврат;
	Конецесли;
	
КонецПроцедуры

&НаСервере
Процедура ЗапускОтчета(ТабДок)
	ДокументОбъект = РеквизитФормыВЗначение("Объект");
	ДокументОбъект.ПоказатьНаСервере(ТабДок) ;
Конецпроцедуры




&НаСервере
Процедура ПоказатьНаСервере(ТабДок) Экспорт
	
	//Обработка =  РеквизитФормыВЗначение("Объект");
	Макет = ПолучитьМакет("Макет"); 		
	//Заполнение маккета текстом приветсвия, кольво и сумма
	//Макет.Параметры.СуммаМакета = формат(СуммаДокумента, "ЧДЦ=0");
	Макет.Параметры.ДатаНачало = формат(Дата.ДатаНачала, "ДЛФ=ДД");
	Макет.Параметры.ДатаКонец = формат(Дата.ДатаОкончания, "ДЛФ=ДД");
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ЗаказКлиента.Номер КАК Номер,
	|	ЗаказКлиента.Дата КАК Дата,
	|	ЗаказКлиента.Контрагент.Наименование КАК КонтрагентНаименование,
	|	ЗаказКлиента.СуммаДокумента КАК СуммаДокумента,
	|	ЗаказКлиента.Менеджер.Наименование КАК МенеджерНаименование
	|ИЗ
	|	Документ.ЗаказКлиента КАК ЗаказКлиента
	|ГДЕ
	|	ЗаказКлиента.СуммаДокумента >= &СуммаДокумента
	|	И ЗаказКлиента.Дата > &ДатаНач
	|	И ЗаказКлиента.Дата < &Датакон
	|	И НЕ ЗаказКлиента.ПометкаУдаления
	|	И ЗаказКлиента.Проведен";
	
	
	Запрос.УстановитьПараметр("ДатаНач", Дата.ДатаНачала);
	Запрос.УстановитьПараметр("ДатаКон", Дата.ДатаОкончания);
	Запрос.УстановитьПараметр("СуммаДокумента", МинимальнаяСумма );
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	//просчет количества заказов	
	КоличествоЗаказов = ВыборкаДетальныеЗаписи.Количество();
	Макет.Параметры.КоличествоЗаказов = КоличествоЗаказов;
	//
	
	ОбластьЗаголовок = Макет.ПолучитьОбласть("Заголовок");
	ОбластьПодвал = Макет.ПолучитьОбласть("Подвал");
	ОбластьШапкаТаблицы = Макет.ПолучитьОбласть("ШапкаТаблицы");
	ОбластьПодвалТаблицы = Макет.ПолучитьОбласть("ПодвалТаблицы");
	ОбластьДетальныхЗаписей = Макет.ПолучитьОбласть("Детали");	
	ТабДок.Очистить();
	ТабДок.Вывести(ОбластьЗаголовок);
	ТабДок.Вывести(ОбластьШапкаТаблицы);
	ТабДок.НачатьАвтогруппировкуСтрок();	
	СуммаДокументов = 0;		
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		СуммаДокументов = СуммаДокументов + ВыборкаДетальныеЗаписи.СуммаДокумента;
		ОбластьДетальныхЗаписей.Параметры.Заполнить(ВыборкаДетальныеЗаписи);
		ОбластьДетальныхЗаписей.Параметры.МенеджерНаименование = ФизическиеЛицаКлиентСервер.ФамилияИнициалыФизЛица(ВыборкаДетальныеЗаписи.МенеджерНаименование);
		ОбластьДетальныхЗаписей.Параметры.СуммаДокумента = формат(СуммаДокументов, "ЧДЦ=0"); 
		ТабДок.Вывести(ОбластьДетальныхЗаписей, ВыборкаДетальныеЗаписи.Уровень());	
	КонецЦикла;
	
	ОбластьПодвал.Параметры.ИтогоКоличество = формат(СуммаДокументов, "ЧДЦ=0");
	ОбластьПодвал.Параметры.СуммаПрописью =  ЧислоПрописью(формат(СуммаДокументов),"НП=Ложь",",,,м,,,,,0");
	ТабДок.ЗакончитьАвтогруппировкуСтрок();
	ТабДок.Вывести(ОбластьПодвалТаблицы);
	ТабДок.Вывести(ОбластьПодвал);
	//ОбъектНаСервере = РеквизитФормыВЗначение("Объект");
	ОтправкаУведомлений(ТабДок);
	
КонецПроцедуры

Процедура ОтправкаУведомлений(ТабДок) Экспорт
	
	ИПП = Новый ИнтернетПочтовыйПрофиль;
	ИПП.АдресСервераSMTP = "smtp.yandex.ru";
	ИПП.ПарольSMTP = "A-_HNvQj5f!zUtn";
	ИПП.ПользовательSMTP = "reportMyCompanyName@yandex.ru";
	ИПП.ПортSMTP = 25;
	
	Сообщение = Новый ИнтернетПочтовоеСообщение;
	Сообщение.Кодировка = "UTF-8";
	Сообщение.Получатели.Добавить("reportMyCompanyName@yandex.ru");
	Сообщение.Отправитель.Адрес = "reportMyCompanyName@yandex.ru";
	Сообщение.Тема = "Крупные заказы за период с " + формат(Дата.ДатаНачала, "ДЛФ=ДД")
	+ " по " + формат(Дата.ДатаОкончания, "ДЛФ=ДД"); 
	
	ПутьHTML = ПолучитьИмяВременногоФайла("html");
	ТабДок.Записать(ПутьHTML, ТипФайлаТабличногоДокумента.HTML);
	HtmlДок = Новый ЧтениеТекста;
	HtmlДок.Открыть(ПутьHTML);
	ТекстHtmlДока = HtmlДок.Прочитать();
	Текст = Сообщение.Тексты.Добавить(ТекстHtmlДока,ТипТекстаПочтовогоСообщения.HTML);
	Сообщить("Отчет отправлен на почту");		
	Почта = Новый ИнтернетПочта;
	Почта.Подключиться(ИПП);
	Почта.Послать(Сообщение);
	Почта.Отключиться();
	
КонецПроцедуры	
